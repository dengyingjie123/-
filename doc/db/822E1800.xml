<?xml version="1.0" encoding="UTF-8"?>
<sql>
    <select-sql>
        <select id="822E1800">

		SELECT
			* 
		FROM
			(
			SELECT
				CustomerId id,
				sum( TotalPaymentPrincipalMoney ) title,
				CONCAT( DATE_FORMAT( date_add( #{intervalStart}, INTERVAL - 1 MONTH ), '%Y' ), '-', DATE_FORMAT( PaymentTime, '%c-%d' ) ) START 
			FROM
				core_paymentplan 
			WHERE
				state = 0 
				AND DATE_FORMAT( PaymentTime, '%Y-%c' ) = DATE_FORMAT( date_add( #{intervalStart}, INTERVAL - 1 MONTH ), '%Y-%c' ) 
			GROUP BY
				PaymentTime UNION
			SELECT
				CustomerId id,
				sum( TotalPaymentPrincipalMoney ) title,
				CONCAT( DATE_FORMAT( date_add( #{intervalStart}, INTERVAL 0 MONTH ), '%Y' ), '-', DATE_FORMAT( PaymentTime, '%c-%d' ) ) START 
			FROM
				core_paymentplan 
			WHERE
				state = 0 
				AND DATE_FORMAT( PaymentTime, '%Y-%c' ) = DATE_FORMAT( date_add( #{intervalStart}, INTERVAL 0 MONTH ), '%Y-%c' ) 
			GROUP BY
				PaymentTime UNION
			SELECT
				CustomerId id,
				sum( TotalPaymentPrincipalMoney ) title,
				CONCAT( DATE_FORMAT( date_add( #{intervalStart}, INTERVAL 1 MONTH ), '%Y' ), '-', DATE_FORMAT( PaymentTime, '%c-%d' ) ) START 
			FROM
				core_paymentplan 
			WHERE
				state = 0 
				AND DATE_FORMAT( PaymentTime, '%Y-%c' ) = DATE_FORMAT( date_add(  #{intervalStart}, INTERVAL 1 MONTH ), '%Y-%c' ) 
			GROUP BY
				PaymentTime
			) t 
		WHERE
			t.id 	
		IN 
			(
			SELECT
				id CustomerId 
			FROM
				crm_customerpersonal 
			WHERE
				state = 0 UNION
			SELECT
				CustomerId 
			FROM
				core_paymentplan 
			WHERE
				1 = 1 
				AND state = 0 
				AND STATUS = 1 
			)
		
        </select>
    </select-sql>
</sql>